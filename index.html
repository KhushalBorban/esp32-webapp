<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 Real-Time Graph + LED Control</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    #btns {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>

<body>

<h2>ESP32 Real-Time Plot + LED Control</h2>

<div id="btns">
  <button onclick="ledOn()">LED ON</button>
  <button onclick="ledOff()">LED OFF</button>
</div>

<p id="status">Connecting...</p>

<canvas id="chart" height="200"></canvas>

<script>
  // ----------------------------------------------------
  // 1. CONNECT TO ESP32 WEBSOCKET
  // ----------------------------------------------------
  const ws = new WebSocket("ws://ESP_IP_HERE:81/");

  ws.onopen = () => {
    document.getElementById("status").innerHTML = "Connected";
  };

  ws.onclose = () => {
    document.getElementById("status").innerHTML = "Disconnected";
  };

  // ----------------------------------------------------
  // 2. CHART INITIALIZATION
  // ----------------------------------------------------
  const ctx = document.getElementById('chart').getContext('2d');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [], 
      datasets: [
        {
          label: "Voltage (V)",
          data: [],
          borderWidth: 2
        },
        {
          label: "Current (A)",
          data: [],
          borderWidth: 2
        }
      ]
    },
    options: {
      animation: false,
      scales: {
        x: { display: false }
      }
    }
  });

  // ----------------------------------------------------
  // 3. RECEIVE STREAMED DATA FROM ESP32
  // ----------------------------------------------------
  ws.onmessage = (event) => {
    let text = event.data;

    // Expected format: time,voltage,current
    let parts = text.split(",");
    if (parts.length !== 3) return;

    let t = parts[0];
    let v = parseFloat(parts[1]);
    let c = parseFloat(parts[2]);

    chart.data.labels.push(t);
    chart.data.datasets[0].data.push(v);
    chart.data.datasets[1].data.push(c);

    // Keep last 500 points
    if (chart.data.labels.length > 500) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
      chart.data.datasets[1].data.shift();
    }

    chart.update();
  };

  // ----------------------------------------------------
  // 4. BUTTON COMMANDS
  // ----------------------------------------------------
  function ledOn() {
    ws.send("LED_ON");
  }

  function ledOff() {
    ws.send("LED_OFF");
  }
</script>

</body>
</html>




